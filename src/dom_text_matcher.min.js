(function(){window.DomTextMatcher=function(){function t(t){this.mapper=t}return t.prototype.setRootNode=function(t){return this.mapper.setRootNode(t)},t.prototype.setRootId=function(t){return this.mapper.setRootId(t)},t.prototype.setRootIframe=function(t){return this.mapper.setRootIframe(t)},t.prototype.setRealRoot=function(){return this.mapper.setRealRoot()},t.prototype.documentChanged=function(){return this.mapper.documentChanged()},t.prototype.scan=function(){var t,e,n;return e=this.timestamp(),t=this.mapper.scan(),n=this.timestamp(),{time:n-e,data:t}},t.prototype.getDefaultPath=function(){return this.mapper.getDefaultPath()},t.prototype.searchExact=function(t,e,n,r){return null==e&&(e=!0),null==n&&(n=!1),null==r&&(r=null),this.pm||(this.pm=new window.DTM_ExactMatcher),this.pm.setDistinct(e),this.pm.setCaseSensitive(n),this.search(this.pm,t,null,r)},t.prototype.searchRegex=function(t,e,n){return null==e&&(e=!1),null==n&&(n=null),this.rm||(this.rm=new window.DTM_RegexMatcher),this.rm.setCaseSensitive(e),this.search(this.rm,t,null,n)},t.prototype.searchFuzzy=function(t,e,n,r,a){var s,h;return null==n&&(n=!1),null==r&&(r=null),null==a&&(a={}),this.ensureDMP(),this.dmp.setMatchDistance(null!=(s=a.matchDistance)?s:1e3),this.dmp.setMatchThreshold(null!=(h=a.matchThreshold)?h:.5),this.dmp.setCaseSensitive(n),this.search(this.dmp,t,e,r,a)},t.prototype.normalizeString=function(t){return t.replace(/\s{2,}/g," ")},t.prototype.searchFuzzyWithContext=function(t,e,n,r,a,s,h,i){var o,l,p,u,c,m,d,f,M,g,y,D,w,x,R,z,C;if(null==r&&(r=null),null==a&&(a=null),null==s&&(s=!1),null==h&&(h=null),null==i&&(i={}),this.ensureDMP(),null==t||null==e)throw Error("Can not do a context-based fuzzy search with missing context!");return c=this.mapper.getDocLength(),p=null!=r?r-t.length:c/2,this.dmp.setMatchDistance(null!=(R=i.contextMatchDistance)?R:2*c),this.dmp.setMatchThreshold(null!=(z=i.contextMatchThreshold)?z:.5),y=this.dmp.search(this.mapper.corpus,t,p),y.length?(g=y[0].end,M=null!=n?n.length:null!=r&&null!=a?a-r:64,D=this.mapper.corpus.substr(g),u=M,w=this.dmp.search(D,e,u),w.length?(x=g+w[0].start,l={start:g,end:x},f=null!=(C=i.patternMatchThreshold)?C:.5,o=this.analyzeMatch(n,l,!0),null==n||o.exact||f>=o.comparison.errorLevel?(m=this.mapper.getMappingsForCharRange(g,x),d=$.extend({},l,o,m),{matches:[d]}):{matches:[]}):{matches:[]}):{matches:[]}},t.prototype.search=function(t,e,n,r,a){var s,h,i,o,l,p,u,c,m,d,f,M,g,y=this;if(null==r&&(r=null),null==a&&(a={}),null==e)throw Error("Can't search for null pattern!");if(e=e.trim(),null==e)throw Error("Can't search an for empty pattern!");for(s=null!=(g=a.withFuzzyComparison)?g:!1,o=this.timestamp(),null!=r&&this.scan(),l=this.timestamp(),m=t.search(this.mapper.corpus,e,n,a),p=this.timestamp(),h=[],d=function(t){var n,r,a;return n=y.analyzeMatch(e,t,s),r=y.mapper.getMappingsForCharRange(t.start,t.end),a=$.extend({},t,n,r),h.push(a),null},f=0,M=m.length;M>f;f++)c=m[f],d(c);return u=this.timestamp(),i={matches:h,time:{phase0_domMapping:l-o,phase1_textMatching:p-l,phase2_matchMapping:u-p,total:u-o}}},t.prototype.timestamp=function(){return(new Date).getTime()},t.prototype.analyzeMatch=function(t,e,n){var r,a,s;return null==n&&(n=!1),r=this.normalizeString(t),a=this.normalizeString(this.mapper.getContentForCharRange(e.start,e.end)),s={found:a,exact:a===r},!s.exact&&n&&(this.ensureDMP(),s.comparison=this.dmp.compare(r,a)),s},t.prototype.ensureDMP=function(){if(null==this.dmp){if(null==window.DTM_DMPMatcher)throw Error("DTM_DMPMatcher is not available. Have you loaded the text match engines?");return this.dmp=new window.DTM_DMPMatcher}},t}()}).call(this);